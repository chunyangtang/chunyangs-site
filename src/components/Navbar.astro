---
// src/components/Navbar.astro
import { Github, Linkedin, GraduationCap, Menu, X } from 'lucide-react';
import ThemeToggle from './ThemeToggle.astro';
import { siteProfile } from '../../data/site';

const normalizePath = (value: string) => {
  const normalized = value.replace(/\/+$/, '');
  return normalized === '' ? '/' : normalized;
};

const currentPath = normalizePath(Astro.url.pathname);
const isActive = (href: string) => normalizePath(href) === currentPath;

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/profile', label: 'Profile' },
  { href: '/projects', label: 'Projects' },
  { href: '/blog', label: 'Blog' },
];
---

<nav class="fixed top-0 w-full z-50 backdrop-blur-md bg-white/70 dark:bg-gray-900/80 border-b border-gray-100 dark:border-gray-800 transition-colors">
  <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between gap-3">
    
    <a href="/" class="font-bold text-xl tracking-tight hover:text-blue-600 transition-colors dark:text-gray-100">
      Chunyang<span class="text-blue-600">.</span>
    </a>

    <div class="hidden md:flex items-center space-x-8 text-sm font-medium text-gray-600 dark:text-gray-300">
      {navLinks.map((link) => (
        <a
          href={link.href}
          aria-current={isActive(link.href) ? 'page' : undefined}
          class={`transition-colors ${
            isActive(link.href)
              ? 'text-gray-900 dark:text-gray-100'
              : 'hover:text-black dark:hover:text-gray-100'
          }`}
        >
          {link.label}
        </a>
      ))}
    </div>

    <div class="flex items-center gap-2 md:gap-4">
      <div class="hidden md:flex items-center space-x-4">
        <a href={siteProfile.githubUrl} target="_blank" rel="noopener noreferrer" aria-label="GitHub profile" class="text-gray-500 hover:text-black dark:text-gray-400 dark:hover:text-gray-100 transition-transform hover:scale-110">
          <Github size={20} />
        </a>
        <a href={siteProfile.linkedinUrl} target="_blank" rel="noopener noreferrer" aria-label="LinkedIn profile" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-transform hover:scale-110">
          <Linkedin size={20} />
        </a>
        <a href={siteProfile.googleScholarUrl} target="_blank" rel="noopener noreferrer" aria-label="Google Scholar profile" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-transform hover:scale-110">
          <GraduationCap size={20} />
        </a>
      </div>

      <div class="pl-2 md:pl-4 border-l border-gray-200 dark:border-gray-700">
        <ThemeToggle />
      </div>

      <button
        id="mobile-menu-toggle"
        type="button"
        class="md:hidden inline-flex items-center justify-center rounded-lg p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
        aria-label="Toggle navigation menu"
        aria-controls="mobile-menu"
        aria-expanded="false"
      >
        <Menu id="mobile-menu-open-icon" size={20} />
        <X id="mobile-menu-close-icon" size={20} class="hidden" />
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="hidden md:hidden border-t border-gray-100 dark:border-gray-800 bg-white/95 dark:bg-gray-900/95">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex flex-col gap-1 text-sm font-medium text-gray-700 dark:text-gray-200">
        {navLinks.map((link) => (
          <a
            href={link.href}
            aria-current={isActive(link.href) ? 'page' : undefined}
            data-mobile-nav-link
            class={`rounded-lg px-3 py-2 transition-colors ${
              isActive(link.href)
                ? 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100'
                : 'hover:bg-gray-100 dark:hover:bg-gray-800'
            }`}
          >
            {link.label}
          </a>
        ))}
      </div>

      <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800 flex items-center gap-5">
        <a href={siteProfile.githubUrl} target="_blank" rel="noopener noreferrer" aria-label="GitHub profile" class="text-gray-500 hover:text-black dark:text-gray-400 dark:hover:text-gray-100 transition-colors">
          <Github size={20} />
        </a>
        <a href={siteProfile.linkedinUrl} target="_blank" rel="noopener noreferrer" aria-label="LinkedIn profile" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors">
          <Linkedin size={20} />
        </a>
        <a href={siteProfile.googleScholarUrl} target="_blank" rel="noopener noreferrer" aria-label="Google Scholar profile" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors">
          <GraduationCap size={20} />
        </a>
      </div>
    </div>
  </div>
</nav>

<script>
  const initMobileMenu = () => {
    const toggleBtn = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const openIcon = document.getElementById('mobile-menu-open-icon');
    const closeIcon = document.getElementById('mobile-menu-close-icon');

    if (!(toggleBtn && mobileMenu && openIcon && closeIcon)) {
      return;
    }

    const setOpen = (isOpen) => {
      mobileMenu.classList.toggle('hidden', !isOpen);
      toggleBtn.setAttribute('aria-expanded', String(isOpen));
      openIcon.classList.toggle('hidden', isOpen);
      closeIcon.classList.toggle('hidden', !isOpen);
    };

    setOpen(false);

    toggleBtn.onclick = () => {
      const isOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
      setOpen(!isOpen);
    };

    mobileMenu.querySelectorAll('[data-mobile-nav-link]').forEach((link) => {
      link.onclick = () => setOpen(false);
    });
  };

  initMobileMenu();
  if (!window.__mobileMenuInitBound) {
    document.addEventListener('astro:page-load', initMobileMenu);
    window.__mobileMenuInitBound = true;
  }
</script>
